apiVersion: registry.k8s.io/v1alpha1
kind: ClusterRegistryCredential
metadata:
  name: ghcr
spec:
  provider:
    ghcr:
      # Example GitHub App installation & app IDs (replace with your own)
      installationId: "<github-app-installation-id>"
      appId: "<github-app-id>"
      permissions:
        contents: read
        packages: read
      # Example encrypted private key (replace with your own SOPS-encrypted value)
      privateKey: ENC[AES256_GCM,data:<encrypted-private-key>,iv:<iv>,tag:<tag>,type:str]
  decryption:
    provider: sops
  templates:
    - name: docker-config-json
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: '{{ .DockerConfigJSON }}'
      targets:
        - name: ghcr
          namespace: crossplane-system
        - name: ghcr-helm
          namespace: flux-system
        - name: ghcr-secret
          namespace: service
        - name: ghcr
          namespace: api
    - type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
      data:
        name: ghcr-helm
        type: helm
        enableOCI: "true"
        url: ghcr.io
        username: x-access-token
        password: '{{ .Token }}'
      targets:
        - name: ghcr-token
          namespace: argocd

sops:
  kms:
    - arn: arn:aws:kms:<region>:<account-id>:key/<key-id>
      created_at: "YYYY-MM-DDTHH:MM:SSZ"
      enc: <base64-encoded-encrypted-key-material>
      aws_profile: "<aws-profile-name>"
  lastmodified: "YYYY-MM-DDTHH:MM:SSZ"
  mac: ENC[AES256_GCM,data:<mac-data>,iv:<iv>,tag:<tag>,type:str]
  encrypted_regex: ^(privateKey)$
  version: 3.10.2
